<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档主页</title>
    <link rel="stylesheet" type="text/css" href="../../pubUI.css"/>
</head>
<body>

    <div class="header">
        <span class="header_item" onclick="addDocument()">+添加文档</span>
        <span class="header_item" onclick="moduleManage()">模块管理</span>
    </div>

    <div class="doc_container" style="margin-top: 10px">
        <!-- 模块选择侧边栏 -->
        <div class="doc_sidebar">
            <ul id="doc_sidebar_list" class="sidebar_list">

            </ul>
        </div>
        <!-- 主体 -->
        <div class="doc_main">
            <!-- 主体搜索区域 -->
            <div class="doc_search">
                <input id="doc_search_input" class="input" placeholder="api搜索" oninput="search()"/>
                <button class="button" onclick="search()">搜索</button>
                <button class="button" onclick="reset()">重置搜索</button>
            </div>
            <!-- 数据列表 -->
            <div class="doc_datalist">
                <table id="doc_datalist_tb" class="doc_datalist_tb">

                </table>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer, remote } = require("electron")
        const { db_module, db_doc } = require("../../mainProcessFunc/nedb.js")
        const timeToDate = require("../../utils/timestampToDateTime.js")

        window.onload = function () {
            window.win_objs = remote.getGlobal("win_objs")
            window.win_self_id   = ""
            window.win_parent_id = ""
            window.cur_module_id = "-1"
            queryModuleList()
            search()
        }

        ipcRenderer.on('options',(event, arg) => {
            window.win_self_id   = arg.relationship.win_self_id   ? arg.relationship.win_self_id   : ''
            window.win_parent_id = arg.relationship.win_parent_id ? arg.relationship.win_parent_id : ''
            window.project_id    = arg.project_id // 所属项目id
            window.project_name  = arg.data.name
            document.title = "文档主页（" + arg.data.name + "）"
        })

        // 查询模块列表显示到侧边栏
        function queryModuleList () {
            let tmp_dom = `
                <li class="doc_sidebar_li" onclick="clickSidebarModule('-1')">
                    全部
                </li>
            `
            db_module.find({}, (err, docs) => {
                for (let i=0; i<docs.length; i++) {
                    tmp_dom += `
                        <li class="doc_sidebar_li" onclick="clickSidebarModule('${docs[i]._id}')">
                            ${docs[i].name}
                        </li>
                    `
                }
            })
            document.getElementById("doc_sidebar_list").innerHTML = tmp_dom
        }

        // 打开添加文档
        function addDocument () {
            ipcRenderer.send("createWindow", {
                "relationship": { "win_parent_id": window.win_self_id },
                "window": "docAddEdit",
                "project_id": window.project_id,
                "data": {
                    "mode": "add"
                }
            })
        }

        // 打开模块管理
        function moduleManage () {
            ipcRenderer.send("createWindow", {
                "relationship": { "win_parent_id": window.win_self_id },
                "window": "moduleIndex",
                "project_id": window.project_id,
                "data": {
                    "name": window.project_name
                }
            })
        }

        // 点击侧边栏模块列表
        function clickSidebarModule (_id) {
            window.cur_module_id = _id
            // 如是是全部
            if (_id == "-1") {

            }
            // 如果不是全部
            else {
                
            }
        }

        // 搜索
        function search () {
            const module_id = window.cur_module_id
            const name      = document.getElementById("doc_search_input").value
            db_doc.find({
                "module_id": module_id,
                "name":      name
            }, (err, docs) =>{
                randerTableList(docs)
            })
        }
        
        // 重置
        function reset () {

        }

        // 渲染主列表
        function randerTableList (dataObjArr) {
            let tmp_dom = `
                <tr class="doc_datalist_tr">
                    <td class="doc_datalist_td">所属模块</td>
                    <td class="doc_datalist_td">api名称</td>
                    <td class="doc_datalist_td">作用</td>
                    <td class="doc_datalist_td">创建时间</td>
                    <td class="doc_datalist_td">操作</td>
                </tr>
            `
            for (let i=0; i<dataObjArr.length; i++) {
                tmp_dom += `
                    <tr class="doc_datalist_tr">
                        <td class="doc_datalist_td"></td>    
                    </tr>
                `
            }
            document.getElementById("doc_datalist_tb").innerHTML = tmp_dom
        }

    </script>

</body>
</html>